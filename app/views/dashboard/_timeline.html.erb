<%
  # Build timeline data
  timeline_events = allocation_result[:timeline].map do |timeline_item|
    allocation = allocation_result[:allocations].find { |a| a[:item_name] == timeline_item[:item].name }
    if allocation && allocation[:completion_date]
      {
        item: timeline_item[:item],
        date: allocation[:completion_date],
        type: timeline_item[:item].item_type
      }
    end
  end.compact.sort_by { |e| e[:date] }

  # Calculate timeline range dynamically based on events
  if timeline_events.any?
    first_event_date = timeline_events.first[:date]
    last_event_date = timeline_events.last[:date]

    # Start from 2 weeks before first event or today, whichever is earlier
    min_date = [first_event_date - 2.weeks, Date.current].min

    # End 2-4 weeks after last event (10% of range, capped at 1 month)
    range_days = (last_event_date - min_date).to_i
    padding_days = [(range_days * 0.1).to_i, 14].max  # At least 2 weeks
    padding_days = [padding_days, 30].min  # Cap at 1 month
    max_date = last_event_date + padding_days.days
  else
    # No events, show a default range
    min_date = Date.current
    max_date = Date.current + 3.months
  end

  date_range = (max_date - min_date).to_i
%>

<% if timeline_events.any? %>
  <!-- Timeline visualization -->
  <div class="relative py-8 px-8">
    <!-- Top spacing for labels above timeline -->
    <div class="h-16"></div>

    <!-- Timeline bar with markers -->
    <div class="relative h-24">
      <!-- The horizontal line -->
      <div class="absolute left-0 right-0 top-8 h-1 bg-gray-300"></div>

      <!-- Timeline markers -->
      <% timeline_events.each_with_index do |event, index| %>
        <% position = ((event[:date] - min_date).to_i.to_f / date_range * 100).round(2) %>
        <%
          # Alternate items above and below the timeline to prevent overlap
          is_above = index.even?
          text_color = event[:type] == 'target_date' ? 'text-red-600' : event[:type] == 'sequential' ? 'text-blue-600' : 'text-green-600'
          triangle_color = event[:type] == 'target_date' ? 'red' : event[:type] == 'sequential' ? 'blue' : 'green'
          # Generate a stable ID for each item so we can track it across updates
          item_id = "timeline-marker-#{event[:item].name.parameterize}"
        %>

        <!-- Marker container with transition -->
        <div class="timeline-marker absolute"
             id="<%= item_id %>"
             data-item-name="<%= event[:item].name %>"
             style="left: <%= position %>%; top: 32px; transform: translateX(-50%); transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);">
          <% if is_above %>
            <!-- Above timeline -->
            <div class="flex flex-col items-center" style="position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); transition: opacity 0.4s;">
              <div class="text-xs font-semibold <%= text_color %> whitespace-nowrap" style="transition: color 0.3s;">
                <%= event[:item].name %>
              </div>
              <!-- Date between name and triangle -->
              <div class="text-[10px] text-gray-500 whitespace-nowrap my-0.5" style="transition: color 0.3s;">
                <%= event[:date].strftime('%m/%d/%y') %>
              </div>
              <!-- Triangle pointing down -->
              <div style="width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid <%= triangle_color == 'red' ? '#DC2626' : triangle_color == 'blue' ? '#2563EB' : '#059669' %>;"></div>
            </div>
          <% else %>
            <!-- Below timeline -->
            <div class="flex flex-col items-center" style="position: absolute; top: 16px; left: 50%; transform: translateX(-50%); transition: opacity 0.4s;">
              <!-- Triangle pointing up -->
              <div style="width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 6px solid <%= triangle_color == 'red' ? '#DC2626' : triangle_color == 'blue' ? '#2563EB' : '#059669' %>;"></div>
              <!-- Date between triangle and name -->
              <div class="text-[10px] text-gray-500 whitespace-nowrap my-0.5" style="transition: color 0.3s;">
                <%= event[:date].strftime('%m/%d/%y') %>
              </div>
              <div class="text-xs font-semibold <%= text_color %> whitespace-nowrap" style="transition: color 0.3s;">
                <%= event[:item].name %>
              </div>
            </div>
          <% end %>

          <!-- Dot on the timeline -->
          <div class="absolute" style="top: -1px; left: 50%; transform: translateX(-50%);">
            <div class="w-3 h-3 rounded-full border-2 border-white shadow <%= event[:type] == 'target_date' ? 'bg-red-500' : event[:type] == 'sequential' ? 'bg-blue-500' : 'bg-green-500' %>" style="transition: background-color 0.3s, transform 0.3s;"></div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Bottom spacing -->
    <div class="h-12"></div>

    <!-- Date range labels -->
    <div class="flex justify-between text-sm text-gray-600 font-medium" style="transition: opacity 0.4s;">
      <span style="transition: opacity 0.3s;"><%= min_date.strftime('%B %Y') %></span>
      <span style="transition: opacity 0.3s;"><%= max_date.strftime('%B %Y') %></span>
    </div>
  </div>

  <!-- Legend -->
  <div class="flex items-center gap-6 mb-6 text-sm">
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded-full bg-red-500"></div>
      <span class="text-gray-600">Target Date</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded-full bg-blue-500"></div>
      <span class="text-gray-600">Sequential</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded-full bg-green-500"></div>
      <span class="text-gray-600">Percentage</span>
    </div>
  </div>
<% else %>
  <p class="text-sm text-gray-500">No items to display on timeline</p>
<% end %>
